---
layout: post
title: range copy
date: '2011-10-27T10:00:00.000-07:00'
author: Kirk
tags:
- programming
modified_time: '2012-04-23T23:34:08.251-07:00'
blogger_id: tag:blogger.com,1999:blog-7018293688983612487.post-53776120968092851
blogger_orig_url: http://kirkshoop.blogspot.com/2011/10/range-copy.html
---

<p>The <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2006/n2068.html">range library</a> proposal for the std library included <code class="prettyprint lang-cpp">copy_range</code> which required that the dest range have a constructor that took begin and end iterators. This was not applicable to C struct ranges like <code class="prettyprint lang-cpp">UNICODE_STRING</code>. </p><p>I decided to fix this by following the pattern for the <code class="prettyprint lang-cpp">begin</code> and <code class="prettyprint lang-cpp">end</code> free-functions. A free-function named <code class="prettyprint lang-cpp">copy</code> calls a free-function named <code class="prettyprint lang-cpp">range_copy</code> via ADL that can be overloaded for each Range type. The default <code class="prettyprint lang-cpp">range_copy</code> has the same behavior that the proposed <code class="prettyprint lang-cpp">copy_range</code> provided, but now other <code class="prettyprint lang-cpp">range_copy</code> overloads can be written. </p><h2><code class="prettyprint lang-cpp">UNICODE_STRING</code> usage</h2><p>This snippet shows some of the operations now enabled. </p><pre class="prettyprint linenums lang-cpp"><br />auto helloRange = as_literal(L"hello");<br />auto title = copy&lt;std::wstring&gt;(helloRange);<br /><br />auto unicodeHello = copy&lt;UNICODE_STRING&gt;(helloRange);<br />auto stringRange = make_range(unicodeHello);<br />auto unicodeTitle = copy&lt;UNICODE_STRING&gt;(<br />    make_range_raw(title)<br />    );<br />stringRange = make_range(unicodeTitle);<br /></pre><ul><li>line 1 will make a <code class="prettyprint lang-cpp">range&lt;const wchar_t*&gt;</code> that points to the static string array. </li><li>line 2 will make a <code class="prettyprint lang-cpp">std::wstring</code> that holds a copy of the static string array. </li><li>line 4 will make a <code class="prettyprint lang-cpp">UNICODE_STRING</code> that points to the static string array. </li><li>line 5 will make a <code class="prettyprint lang-cpp">range&lt;PWSTR&gt;</code> that points to the static string array. </li><li>line 6 will make a <code class="prettyprint lang-cpp">UNICODE_STRING</code> that points to the <code class="prettyprint lang-cpp">wstring</code> copy of the static string array. </li><li>line 9 will make a <code class="prettyprint lang-cpp">range&lt;PWSTR&gt;</code> that points to the <code class="prettyprint lang-cpp">wstring</code> copy of the static string array. </li></ul><h2>Implementation</h2><p>maintained <a href="http://github.com/kirkshoop/libraries">here</a></p><pre class="prettyprint linenums lang-cpp"><br />template&lt; class RangeTo, class RangeFrom &gt;<br />auto range_copy(RangeFrom &amp;&amp; r, RangeTo*) -&gt;<br />decltype(<br />  RangeTo(<br />      begin(std::forward&lt;RangeFrom&gt;(r)),<br />      end(std::forward&lt;RangeFrom&gt;(r))<br />  )<br />)<br />{<br />  return RangeTo(<br />      begin(std::forward&lt;RangeFrom&gt;(r)),<br />      end(std::forward&lt;RangeFrom&gt;(r))<br />      );<br />}<br /><br />template&lt; class RangeTo, class RangeFrom &gt;<br />auto copy(RangeFrom &amp;&amp; r) -&gt;<br />decltype(<br />  range_copy(<br />      std::forward&lt;RangeFrom&gt;(r),<br />      reinterpret_cast&lt;RangeTo*&gt;(nullptr)<br />  )<br />)<br />{<br />  return range_copy(<br />      std::forward&lt;RangeFrom&gt;(r),<br />      reinterpret_cast&lt;RangeTo*&gt;(nullptr)<br />      );<br />}<br /></pre><p>line 27 passes in a <code class="prettyprint lang-cpp">nullptr</code> cast to a <code class="prettyprint lang-cpp">RangeTo*</code> this dummy parameter is ugly but required to enable Argument-Dependent-Lookup (ADL) when <code class="prettyprint lang-cpp">range_copy</code> is implemented in <code class="prettyprint lang-cpp">RangeTo</code>'s namespace. I considered using the parameter rather than returning a <code class="prettyprint lang-cpp">RangeTo</code> by-value, but then <code class="prettyprint lang-cpp">RangeTo</code> must be default-constructable since the <code class="prettyprint lang-cpp">copy</code> free-function would have to have one on the stack in order to pass a pointer into <code class="prettyprint lang-cpp">range_copy</code>. The current definition allows the overload for <code class="prettyprint lang-cpp">RangeTo</code> to use any constructor. </p><h2><code class="prettyprint lang-cpp">UNICODE_STRING</code> implementation</h2><p>Now enabling <code class="prettyprint lang-cpp">UNICODE_STRING</code> for use with the range library requires only this </p><pre class="prettyprint lang-cpp"><br />// enable UNICODE_STRING &lt;-&gt; range<br /><br />PWSTR range_begin(const UNICODE_STRING&amp; string)<br />{<br />  return string.Buffer;<br />}<br /><br />PWSTR range_end(const UNICODE_STRING&amp; string)<br />{<br />  return string.Buffer + (string.Length / 2);<br />}<br /><br />template&lt; class RangeFrom &gt;<br />UNICODE_STRING range_copy(<br />  RangeFrom &amp;&amp; r,<br />  UNICODE_STRING*<br />)<br />{<br />  UNICODE_STRING result = {};<br /><br />  result.Buffer = const_cast&lt;PWSTR&gt;(<br />      begin(std::forward&lt;RangeFrom&gt;(r))<br />      );<br />  result.Length = size_cast&lt;USHORT&gt;(<br />      size(std::forward&lt;RangeFrom&gt;(r)) * 2<br />      );<br />  result.MaximumLength = size_cast&lt;USHORT&gt;(<br />      size(std::forward&lt;RangeFrom&gt;(r)) * 2<br />      );<br /><br />  return result;<br />}<br /></pre> 