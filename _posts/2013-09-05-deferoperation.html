---
layout: post
title: DeferOperation
date: '2013-09-05T23:28:00.000-07:00'
author: Kirk
tags: 
modified_time: '2013-09-06T08:14:29.389-07:00'
blogger_id: tag:blogger.com,1999:blog-7018293688983612487.post-8602309627615195152
blogger_orig_url: http://kirkshoop.blogspot.com/2013/09/deferoperation.html
---

<span style="font-family: &quot;Trebuchet MS&quot;, sans-serif;">I have been working on RxC++ for a few months now. I have added Schedulers and lots of operators. Now I am trying to apply Rx to a C++ Windows Store app.<br /><br />I was told that Deferrals&nbsp;did not compose well with Rx.&nbsp;This motivated me to design the DeferOperation operator.<br /><br />DeferOperation demonstrates how Rx can be extended by a few engineers to provide services for many. Another way to say this is that Rx allows Async Algorithms to be written once, carefully, so that many others can re-use them.</span><span style="font-family: &quot;Trebuchet MS&quot;, sans-serif;"><br /><br />These are all references to the Windows 8.1 Accelerometer <a href="https://github.com/kirkshoop/rxaccelerometer/">sample</a> I am modifying.<br /><br />Usage (App.Xaml.Cpp):<br /><script src="https://gist.github.com/kirkshoop/6459935.js"></script><br />DeferOperation defaults to the ui thread by reading the context off of the Window, but when the suspending event is fired the Window is not valid, so this uses the current thread scheduler explicitly. publish and connect_forever ensure that the work is done even if nothing subscribes the result.</span><br /><span style="font-family: &quot;Trebuchet MS&quot;, sans-serif;"></span><br /><span style="font-family: &quot;Trebuchet MS&quot;, sans-serif;">The implementation follows.</span><br /><span style="font-family: &quot;Trebuchet MS&quot;, sans-serif;"></span><br /><span style="font-family: &quot;Trebuchet MS&quot;, sans-serif;">The core of the DeferOperation operator is (cpprx/rx-winrt.hpp):<br /><script src="https://gist.github.com/kirkshoop/6460005.js"></script><br />sop is the first lambda from the usage (cpprx/rx-winrt.hpp):<br /><script src="https://gist.github.com/kirkshoop/6460038.js"></script><br />sob is the second lambda from the usage (the OperationPattern is passed so that the SuspendingOperation and the Deferral are available to the sequence if it wants to see the Deadline or Complete early, for example) (cpprx/rx-winrt.hpp)<script src="https://gist.github.com/kirkshoop/6460024.js"></script><br /></span><span style="font-family: &quot;Trebuchet MS&quot;, sans-serif;">Using will retrieve the resource (OperationPattern), subscribe to the result of sob and Dispose the resource when the subscription completes or errors.<br /><br />OperationPattern provides the abstraction needed by Using. It will call get and complete the deferral (cpprx/rx-winrt.hpp):<br /><script src="https://gist.github.com/kirkshoop/6460133.js"></script>&nbsp;</span>