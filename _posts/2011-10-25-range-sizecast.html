---
layout: post
title: range size_cast
date: '2011-10-25T10:10:00.000-07:00'
author: Kirk
tags:
- programming
modified_time: '2011-10-25T10:10:00.320-07:00'
blogger_id: tag:blogger.com,1999:blog-7018293688983612487.post-1069141729067104229
blogger_orig_url: http://kirkshoop.blogspot.com/2011/10/range-sizecast.html
---

<p>The <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2006/n2068.html">range library</a> proposal for the std library included <code class="prettyprint lang-cpp">size</code> which calculated the distance between <code class="prettyprint lang-cpp">begin(r)</code> and <code class="prettyprint lang-cpp">end(r)</code>. This value usually ends up in a <code class="prettyprint lang-cpp">ptrdiff_t</code>. I often need to put the size of a range into much smaller size types when using C APIs and C structs. Just adding a <code class="prettyprint lang-cpp">static_cast</code> is no sufficient as I not only want to cast the type, but ensure that the value fits. </p><p>I added <code class="prettyprint lang-cpp">size_cast</code>. It requires an explicit ReturnType template parameter. Then it can verify that the value will fit and only then do a <code class="prettyprint lang-cpp">static_cast</code> to coerce the value into the ResultType. </p><p>The next post will demonstrate some usage. </p><h2>Implementation</h2><p>maintained <a href="http://github.com/kirkshoop/libraries">here</a></p><pre class="prettyprint lang-cpp"><br />template&lt; class ResultType, class InputType &gt;<br />ResultType<br />size_cast(InputType size)<br />{<br />  const static size_t<br />  bitsOfPositiveRepresentationInResultType =<br />    (sizeof(ResultType) * 8) -<br />    static_cast&lt;ResultType&gt;(<br />        std::is_signed&lt;ResultType&gt;::value);<br />  const static size_t<br />  bitsOfPositiveRepresentationInInputType =<br />    (sizeof(InputType) * 8) -<br />    static_cast&lt;InputType&gt;(<br />        std::is_signed&lt;InputType&gt;::value);<br />  typedef<br />  std::conditional &lt;<br />  bitsOfPositiveRepresentationInResultType &lt;<br />  bitsOfPositiveRepresentationInInputType,<br />  InputType,<br />  ResultType<br />  &gt;::type<br />  check_type;<br />  check_type size_check = static_cast&lt;check_type&gt;(size);<br />  FAIL_FAST_IF(<br />    (false,<br />      (std::is_signed&lt;InputType&gt;::value &amp;&amp; size &lt; 0)) ||<br />        (size_check &gt;&gt; (<br />          bitsOfPositiveRepresentationInResultType - 1)) != 0,<br />    ERROR_INVALID_PARAMETER<br />  );<br />  return static_cast&lt;ResultType&gt;(size);<br />}<br /></pre>