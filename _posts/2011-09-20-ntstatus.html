---
layout: post
title: NTSTATUS
date: '2011-09-20T22:00:00.000-07:00'
author: Kirk
tags:
- win32
- error handling
- programming
modified_time: '2011-09-20T22:00:04.347-07:00'
blogger_id: tag:blogger.com,1999:blog-7018293688983612487.post-7181549941167298588
blogger_orig_url: http://kirkshoop.blogspot.com/2011/09/ntstatus.html
---

<p><code>NTSTATUS</code> was defined for code native to the Windows NT operating system. It was a part of the very clean separations built between the core OS and the various subsystems where user code was expected to run (POSIX, WIN32, WIN16/DOS, OS/2). Over time it has begun to leak into code in the WIN32 subsystem. One example of leakage is the <a href="http://msdn.microsoft.com/en-us/library/aa833130.aspx">BCrypt Api's</a>. </p><p>Just including ntstatus.h and windows.h together produces errors:</p><pre class="prettyprint lang-cpp"><br />main.cpp<br />#include &lt;windows.h&gt;<br />#include &lt;winternl.h&gt;<br />#include &lt;ntstatus.h&gt;<br /><br />int main()<br />{<br />  return 0;<br />}<br /><br />&gt;cl main.cpp<br />Microsoft (R) 32-bit C/C++ Optimizing Compiler Version 16.00.30319.01 for 80x86<br />Copyright (C) Microsoft Corporation.  All rights reserved.<br /><br />main.cpp<br />[redacted]ntstatus.h(147) <br />    : warning C4005: 'STATUS_WAIT_0' <br />        : macro redefinition<br />    [redacted]winnt.h(1983) <br />        : see previous definition of 'STATUS_WAIT_0'<br />...<br /></pre><p>I spent some hours recently tracking down an incantation that would allow ntstatus.h to be included without the errors, the following was the result: </p><pre class="prettyprint lang-cpp"><br />#define WIN32_NO_STATUS<br />#include &lt;windows.h&gt;<br />#undef WIN32_NO_STATUS<br /><br />#include &lt;winternl.h&gt;<br />#include &lt;ntstatus.h&gt;<br /></pre><p><code>NTSTATUS</code> defines 2bits to hold four severity levels, SUCCESS, INFORMATION, WARNING, ERROR.<br />There are 12bits set aside for Facilities, which are used to create feature-specific error codes. Within each facility is 16bits to define codes specific to that facility.<br /><code>FACILITY_NULL</code> contains generic codes like <code>STATUS_SUCCESS</code>.<br /><code>FACILITY_NTWIN32</code> contains all the WINERROR codes.<br /></p><p>Checking <code>NTSTATUS</code> values must be done via the NT_SUCCESS(ntstatus), NT_INFORMATION(ntstatus), NT_WARNING(ntstatus) or NT_ERROR(ntstatus) macros. </p><p><h3><code>NTSTATUS</code> Usage</h3><pre class="prettyprint lang-cpp"><br />NTSTATUS ApiReturningNtStatus(HANDLE handle)<br />{<br />  if (handle == INVALID_HANDLE_VALUE) {<br />    return STATUS_INVALID_PARAMETER;<br />  }<br />  return STATUS_SUCCESS;<br />}<br /><br />NTSTATUS ntstatus = STATUS_SUCCESS;<br />HANDLE handle = INVALID_HANDLE_VALUE;<br />ntstatus = ApiReturningNtStatus(handle);<br />if (!NT_SUCCESS(ntstatus))<br />{<br />  printf("ApiReturningNtStatus returned %x", ntstatus);<br />  exit();<br />}<br /></pre></p><p><h3>Conversions to <code>NTSTATUS</code></h3><pre class="prettyprint lang-cpp"><br />HRESULT = S_OK;<br />NTSTATUS ntstatus = STATUS_SUCCESS;<br />if (hr &amp; FACILITY_NT_BIT)<br />{<br />  ntstatus = hr &amp; ~FACTILITY_NT_BIT;<br />} else if (HRESULT_FACILITY(hr) == FACILITY_WIN32)<br />{<br />  ntstatus = NTSTATUS_FROM_WIN32(HRESULT_CODE(hr));<br />} else if (SUCCEEDED(hr))<br />{<br />  ntstatus = STATUS_SUCCESS;<br />} else<br />{<br />  ntstatus = STATUS_UNSUCCESSFUL;<br />}<br /><br />DWORD winerror = ERROR_SUCCESS;<br />NTSTATUS ntstatus = STATUS_SUCCESS;<br />ntstatus = NTSTATUS_FROM_WIN32(winerror);<br /></pre></p><p><h3>Conversions from <code>NTSTATUS</code></h3><pre class="prettyprint lang-cpp"><br />NTSTATUS ntstatus = STATUS_SUCCESS;<br />HRESULT hr = HRESULT_FROM_NT(ntstatus);<br /><br />NTSTATUS ntstatus = STATUS_SUCCESS;<br />DWORD winerror = RtlNtStatusToDosError(ntstatus);<br />if (winerror == ERROR_MR_MID_NOT_FOUND)<br />{<br />  // there is no conversion<br />  return ERROR_UNIDENTIFIED_ERROR;<br />#if 0<br />  // The following is common, but doesn't work out well<br />  // especially when combined with HRESULT_FROM_WIN32<br />  // and NTSTATUS_FROM_WIN32<br />  return ntstatus;<br />#endif<br />}<br /></pre></p>