---
layout: post
title: smartcard_name_and_provider implementation
date: '2012-04-10T10:00:00.000-07:00'
author: Kirk
tags:
- win32
- smart card
- programming
modified_time: '2012-04-23T23:34:37.864-07:00'
blogger_id: tag:blogger.com,1999:blog-7018293688983612487.post-7750319839184286396
blogger_orig_url: http://kirkshoop.blogspot.com/2012/04/smartcardnameandprovider-implementation.html
---

<p>Once the reader monitor has reported the ATR for the card in a reader, it can be used to access the card. </p><p>Windows has a model that gives card manufacturers three options for providing access to a smart card through the crypto apis. </p><ul><li>KSP/CSP - the manufacturer can supply a full KSP(Key Storage Provider) and CSP (Cryptographic Service Provider) and associate it with an ATR. </li><li>Smart Card Minidriver - the manufacturer can supply a minidriver dll that the built-in Smart Card KSP and CSP will load to provide access and associate it with an ATR. </li><li>PICS/GIDS - the manufacturer can provide a card that implements the GIDS or PICS card standard. Windows has built-in minidrivers for these. </li></ul><p>Because of the first option, once an ATR is in hand, <a href="http://www.bing.com/search?q=site%3Amsdn.microsoft.com+meta%3ASearch.MSHAttr.APIName%28'SCardGetCardTypeProviderName'%29"><code class="prettyprint lang-cpp">SCardGetCardTypeProviderName</code></a> must be called to retrieve the KSP or CSP provider name that should be used for the card. </p><p><a href="http://www.bing.com/search?q=site%3Amsdn.microsoft.com+meta%3ASearch.MSHAttr.APIName%28'SCardListCards'%29"><code class="prettyprint lang-cpp">SCardListCards</code></a> will retrieve the card name from an ATR, which is then passed to <a href="http://www.bing.com/search?q=site%3Amsdn.microsoft.com+meta%3ASearch.MSHAttr.APIName%28'SCardGetCardTypeProviderName'%29"><code class="prettyprint lang-cpp">SCardGetCardTypeProviderName</code></a>. Windows only supports one KSP/CSP for an ATR, so even though <a href="http://www.bing.com/search?q=site%3Amsdn.microsoft.com+meta%3ASearch.MSHAttr.APIName%28'SCardListCards'%29"><code class="prettyprint lang-cpp">SCardListCards</code></a> returns a list of card names any one of them can be used to retrieve the provider names. </p><p>Here is the code to get a card name and the KSP provider name. </p><pre class="prettyprint lang-cpp"><br />struct CardWithProvider {<br />  std::wstring cardname;<br />  std::wstring kspname;<br />};<br /><br />inline<br />std::pair&lt;unique_winerror, CardWithProvider&gt;<br />smartcard_name_and_provider(<br />  lib::rng::range&lt;const BYTE*&gt; atr<br />)<br />{<br />  unique_winerror winerror;<br />  unique_close_scardcontext context;<br /><br />  CardWithProvider output;<br /><br />  winerror.reset(<br />    SCardEstablishContext(<br />        SCARD_SCOPE_USER,<br />        NULL,<br />        NULL,<br />        context.replace()<br />    )<br />  );<br />  if (!winerror) {<br />    return std::make_pair(winerror, std::move(output));<br />  }<br /><br />  LPWSTR kspstring = nullptr;<br />  ON_UNWIND(<br />    unwind_kspstring,<br />    [&amp;] { <br />      if (kspstring) {<br />        SCardFreeMemory(context.get(), kspstring);<br />      }<br />    }<br />  );<br />  DWORD ksplength = SCARD_AUTOALLOCATE;<br /><br />  LPWSTR cardsstring = nullptr;<br />  ON_UNWIND_AUTO(<br />    [&amp;] { <br />      if (cardsstring) {<br />        SCardFreeMemory(context.get(), cardsstring);<br />      }<br />    }<br />  );<br />  DWORD cardslength = SCARD_AUTOALLOCATE;<br /><br />  winerror.reset(<br />    SCardListCards(<br />        context.get(),<br />        atr.begin(),<br />        NULL,<br />        NULL,<br />        reinterpret_cast&lt;LPWSTR&gt;(&amp;cardsstring),<br />        &amp;cardslength<br />    )<br />  );<br />  if (winerror == <br />      winerror_cast(SCARD_E_READER_UNAVAILABLE)) {<br />    winerror.suppress();<br />    // don't free the static string we are <br />    // about to assign<br />    unwind_kspstring.dismiss();<br />    kspstring = MS_SMART_CARD_KEY_STORAGE_PROVIDER;<br />    ksplength = wcslen(kspstring);<br />  } else if (!winerror) {<br />    return std::make_pair(winerror, std::move(output));<br />  } else {<br />    winerror.reset(<br />      SCardGetCardTypeProviderName(<br />          context.get(),<br />          cardsstring,<br />          SCARD_PROVIDER_KSP,<br />          reinterpret_cast&lt;LPWSTR&gt;(&amp;kspstring),<br />          &amp;ksplength<br />      )<br />    );<br />    if (!winerror) {<br />      return std::make_pair(winerror, std::move(output));<br />    }<br />  }<br /><br />  if (cardsstring) {<br />    output.cardname = cardsstring;<br />  }<br />  output.kspname = kspstring;<br /><br />  return std::make_pair(winerror, std::move(output));<br />}<br /></pre>