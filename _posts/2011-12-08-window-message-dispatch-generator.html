---
layout: post
title: window message dispatch generator
date: '2011-12-08T10:00:00.000-08:00'
author: Kirk
tags:
- win32
- programming
modified_time: '2011-12-08T10:00:02.745-08:00'
blogger_id: tag:blogger.com,1999:blog-7018293688983612487.post-6160317290724670038
blogger_orig_url: http://kirkshoop.blogspot.com/2011/12/window-message-dispatch-generator.html
---

<p>One goal for this dispatcher was to achieve pay-for-play performance characteristics. The generator builds a recursive type with a recursive dispatch function that only includes the message handling supported by the target. This produces a pretty concise if-else construct.</p><pre class="prettyprint lang-cpp"><br />namespace detail {<br />template&lt;typename WindowClassTag, typename Target&gt;<br />struct generator_end<br />{<br />  typedef<br />    base&lt;WindowClassTag, Target&gt;<br />  type;<br />};<br /></pre><p>generator_end is used to terminate the recursive type being generated. base is defined previously but will be covered later.</p><pre class="prettyprint lang-cpp"><br />template &lt;<br />  typename WindowClassTag,<br />  typename Target,<br />  typename MessageChoice,<br />  typename Base = generator_end&lt;WindowClassTag, Target &gt;&gt;<br />struct generator;<br /></pre><p>This is the prototype for generator, 2 specializations of generator are used to either add or omit a type from the recursive type.</p><pre class="prettyprint lang-cpp"><br />template &lt;<br />  typename WindowClassTag,<br />  typename Target,<br />  template &lt;<br />    typename A,<br />    typename B,<br />    typename C &gt; class MessageChoice,<br />  typename Base &gt;<br />struct generator &lt;<br />  WindowClassTag,<br />  Target,<br />  MessageChoice &lt;<br />    WindowClassTag,<br />    Target,<br />    base&lt;WindowClassTag, Target &gt;&gt; ,<br />  Base &gt;<br />  : public Base<br />{<br />  typedef<br />    MessageChoice &lt;<br />      WindowClassTag,<br />      Target,<br />      typename Base::type &gt;<br />  type;<br />};<br /></pre><p>this specialization of generator matches when the target does support a message. It creates a type result using the supplied MessageChoice which is chained into the recursive type result (by changing the last template parameter to the result of the next recursed generator type result).</p><pre class="prettyprint lang-cpp"><br />template &lt;<br />  typename WindowClassTag,<br />  typename Target,<br />  typename Base &gt;<br />struct generator &lt;<br />  WindowClassTag,<br />  Target,<br />  nohandler,<br />  Base &gt;<br />  : public Base<br />{<br />};<br /></pre><p>This specialization of generator matches when the target does not support the message (the nohandler class is already defined. nohandler will be described later.) There is no type defined here which ensures that no code will be generated for this message. </p><pre class="prettyprint lang-cpp"><br />template &lt;<br />  typename WindowClassTag,<br />  typename Target,<br />  typename Base &gt;<br />struct generator_root<br />  : public Base<br />{<br />};<br />}<br /></pre><p>generator_root provides a container for the generator that allows the type to be stamped out by some macros. </p><pre class="prettyprint lang-cpp"><br />template&lt;typename WindowClassTag, typename Target&gt;<br />struct generator {<br />  typedef<br />    typename detail::generator_root &lt; WindowClassTag, Target<br />#   define WINDOW_MESSAGE_DEFINE_BEGIN_GENERATOR<br />#   include "win32_messages.h"<br />#   undef WINDOW_MESSAGE_DEFINE_BEGIN_GENERATOR<br /><br />#   define WINDOW_MESSAGE_DEFINE_END_GENERATOR<br />#   include "win32_messages.h"<br />#   undef WINDOW_MESSAGE_DEFINE_END_GENERATOR<br />    &gt;::type<br />  type;<br />};<br /></pre><p>This is how the type for a set of messages is created. This marco technique is complicated in order to allow the debugger to step through the dispatch code with source lines. WINDOW_MESSAGE_DEFINE_BEGIN_GENERATOR causes win32_messages.h to resolve to a recursive type for each message, while WINDOW_MESSAGE_DEFINE_END_GENERATOR causes win32_messages.h to resolve to a &lt; for each type, this is required to finish the recursive generator definition. </p><p>Next is a look at the macro machinery.. </p>